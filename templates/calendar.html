{% extends "base.html" %}
{% load custom_filters %}

{% block title %}Event Calendar{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="mb-6 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <img src="{% static 'images/beta-seal.webp' %}" alt="Beta Theta Pi Seal" class="w-12 h-12 sm:w-14 sm:h-14 rounded-full object-contain bg-white p-1 shadow-md">
            <div>
                <h2 class="text-3xl font-bold mb-2">Event Calendar</h2>
                <p class="text-gray-600">View chapter events and meetings</p>
            </div>
        </div>
        {% if user.member_type == 'Officer' or user.member_type == 'Chair' %}
            <div class="flex space-x-2">
                <a href="{% url 'create_event' %}" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    New Event
                </a>
                <a href="{% url 'manage_events' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Manage
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Calendar Grid -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
        <!-- Month Navigation -->
        <div class="bg-blue-600 text-white px-6 py-4 flex items-center justify-between relative">
            <button id="prevMonthBtn" onclick="navigateMonth(-1)" class="hover:bg-blue-700 p-2 rounded transition {% if not can_go_prev %}opacity-50 cursor-not-allowed{% endif %}" {% if not can_go_prev %}disabled{% endif %}>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="relative">
                <button onclick="toggleMonthDropdown()" class="text-2xl font-bold hover:bg-blue-700 px-4 py-2 rounded transition flex items-center space-x-2">
                    <span id="monthYearTitle">{{ month_name }} {{ year }}</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="monthDropdown" class="hidden absolute top-full left-1/2 transform -translate-x-1/2 mt-2 bg-white rounded-lg shadow-xl border border-gray-200 z-50 w-80 max-h-96 overflow-y-auto">
                    <div id="monthDropdownContent" class="p-2">
                        <!-- Month options will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <button id="nextMonthBtn" onclick="navigateMonth(1)" class="hover:bg-blue-700 p-2 rounded transition {% if not can_go_next %}opacity-50 cursor-not-allowed{% endif %}" {% if not can_go_next %}disabled{% endif %}>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>

        <!-- Calendar Table -->
        <div class="p-4">
            <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                <!-- Day headers -->
                <div class="text-center font-semibold text-gray-700 py-2">Sun</div>
                <div class="text-center font-semibold text-gray-700 py-2">Mon</div>
                <div class="text-center font-semibold text-gray-700 py-2">Tue</div>
                <div class="text-center font-semibold text-gray-700 py-2">Wed</div>
                <div class="text-center font-semibold text-gray-700 py-2">Thu</div>
                <div class="text-center font-semibold text-gray-700 py-2">Fri</div>
                <div class="text-center font-semibold text-gray-700 py-2">Sat</div>

                <!-- Calendar days -->
                {% for week in calendar %}
                    {% for day in week %}
                        <div class="min-h-24 border border-gray-200 rounded-lg p-2 {% if day == 0 %}bg-gray-50{% elif day == today %}bg-blue-50 border-blue-400{% else %}bg-white hover:bg-gray-50{% endif %} transition">
                            {% if day != 0 %}
                                <div class="text-right">
                                    <span class="{% if day == today %}bg-blue-600 text-white rounded-full px-2 py-1 text-sm font-bold{% else %}text-gray-700 font-medium{% endif %}">
                                        {{ day }}
                                    </span>
                                </div>
                                {% if day in events_by_day %}
                                    <div class="mt-1 space-y-1">
                                        {% for event in events_by_day|get_item:day %}
                                            <div class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded cursor-pointer hover:bg-blue-200 transition"
                                                 onclick="showEventDetails{{ event.id }}()">
                                                <div class="font-semibold truncate">{{ event.date_time|date:"g:i A" }}</div>
                                                <div class="truncate">{{ event.title }}</div>
                                            </div>
                                            <!-- Hidden event details modal trigger -->
                                            <script>
                                                function showEventDetails{{ event.id }}() {
                                                    document.getElementById('eventModal{{ event.id }}').classList.remove('hidden');
                                                }
                                                function closeEventDetails{{ event.id }}() {
                                                    document.getElementById('eventModal{{ event.id }}').classList.add('hidden');
                                                }
                                            </script>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>

        <!-- Legend -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
            <div class="flex items-center space-x-6 text-sm">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-blue-50 border border-blue-400 rounded mr-2"></div>
                    <span class="text-gray-700">Today</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-blue-100 rounded mr-2"></div>
                    <span class="text-gray-700">Has Events</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Details Modals -->
    {% for day, day_events in events_by_day.items %}
        {% for event in day_events %}
            <div id="eventModal{{ event.id }}" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) closeEventDetails{{ event.id }}()">
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-2xl font-bold text-gray-900">{{ event.title }}</h3>
                        <button onclick="closeEventDetails{{ event.id }}()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <p class="text-gray-700">{{ event.description }}</p>
                        <div class="flex items-center text-gray-600">
                            <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-medium">{{ event.date_time|date:"l, F j, Y at g:i A" }}</span>
                        </div>
                        {% if event.location %}
                            <div class="flex items-center text-gray-600">
                                <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span>{{ event.location }}</span>
                            </div>
                        {% endif %}
                        <div class="flex items-center text-sm text-gray-500">
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span>Posted by {{ event.created_by.get_display_name }}</span>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button onclick="closeEventDetails{{ event.id }}()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endfor %}

    <!-- Upcoming Events List -->
    {% if upcoming_events %}
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Upcoming Events</h3>
            <div class="space-y-3">
                {% for event in upcoming_events %}
                    <div class="border-l-4 border-blue-500 bg-gray-50 p-4 rounded-r-lg hover:bg-gray-100 transition cursor-pointer" onclick="showEventDetails{{ event.id }}()">
                        <h4 class="text-lg font-semibold text-gray-900">{{ event.title }}</h4>
                        <p class="text-gray-600 text-sm mt-1">{{ event.description|truncatewords:15 }}</p>
                        <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                {{ event.date_time|date:"M j, Y - g:i A" }}
                            </div>
                            {% if event.location %}
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    {{ event.location }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

<div id="dynamicModals"></div>

<style>
    .min-h-24 {
        min-height: 6rem;
    }
</style>

<script>
    // Current month and year state
    let currentMonth = {{ month }};
    let currentYear = {{ year }};
    let today = {{ today|default:"null" }};
    let canGoPrev = {{ can_go_prev|yesno:"true,false" }};
    let canGoNext = {{ can_go_next|yesno:"true,false" }};

    // Cache for calendar data
    const calendarCache = {};

    // Preload adjacent months on page load
    window.addEventListener('DOMContentLoaded', function() {
        preloadAdjacentMonths();
        populateMonthDropdown();
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('monthDropdown');
        const button = event.target.closest('button[onclick="toggleMonthDropdown()"]');

        if (!button && !dropdown.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });

    function preloadAdjacentMonths() {
        // Preload previous month
        const prevMonth = currentMonth === 1 ? 12 : currentMonth - 1;
        const prevYear = currentMonth === 1 ? currentYear - 1 : currentYear;
        fetchCalendarData(prevYear, prevMonth, true);

        // Preload next month
        const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;
        const nextYear = currentMonth === 12 ? currentYear + 1 : currentYear;
        fetchCalendarData(nextYear, nextMonth, true);
    }

    function navigateMonth(direction) {
        if (direction === -1) {
            if (currentMonth === 1) {
                currentMonth = 12;
                currentYear--;
            } else {
                currentMonth--;
            }
        } else {
            if (currentMonth === 12) {
                currentMonth = 1;
                currentYear++;
            } else {
                currentMonth++;
            }
        }

        loadCalendar(currentYear, currentMonth);
        preloadAdjacentMonths();
    }

    async function fetchCalendarData(year, month, cacheOnly = false) {
        const cacheKey = `${year}-${month}`;

        if (calendarCache[cacheKey]) {
            return calendarCache[cacheKey];
        }

        try {
            const response = await fetch(`/api/calendar-data/?year=${year}&month=${month}`);
            const data = await response.json();
            calendarCache[cacheKey] = data;
            return data;
        } catch (error) {
            console.error('Error fetching calendar data:', error);
            return null;
        }
    }

    async function loadCalendar(year, month) {
        const data = await fetchCalendarData(year, month);
        if (!data) return;

        // Update title
        document.getElementById('monthYearTitle').textContent = `${data.month_name} ${data.year}`;

        // Render calendar grid
        renderCalendar(data);

        // Update today indicator
        today = data.today;

        // Update navigation button states
        canGoPrev = data.can_go_prev;
        canGoNext = data.can_go_next;
        updateNavigationButtons();
    }

    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prevMonthBtn');
        const nextBtn = document.getElementById('nextMonthBtn');

        if (canGoPrev) {
            prevBtn.disabled = false;
            prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            prevBtn.disabled = true;
            prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        if (canGoNext) {
            nextBtn.disabled = false;
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            nextBtn.disabled = true;
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    function renderCalendar(data) {
        const grid = document.getElementById('calendarGrid');
        let html = `
            <div class="text-center font-semibold text-gray-700 py-2">Sun</div>
            <div class="text-center font-semibold text-gray-700 py-2">Mon</div>
            <div class="text-center font-semibold text-gray-700 py-2">Tue</div>
            <div class="text-center font-semibold text-gray-700 py-2">Wed</div>
            <div class="text-center font-semibold text-gray-700 py-2">Thu</div>
            <div class="text-center font-semibold text-gray-700 py-2">Fri</div>
            <div class="text-center font-semibold text-gray-700 py-2">Sat</div>
        `;

        // Render calendar days
        data.calendar.forEach(week => {
            week.forEach(day => {
                const isToday = day === data.today;
                const isEmpty = day === 0;
                const bgClass = isEmpty ? 'bg-gray-50' : (isToday ? 'bg-blue-50 border-blue-400' : 'bg-white hover:bg-gray-50');

                html += `<div class="min-h-24 border border-gray-200 rounded-lg p-2 ${bgClass} transition">`;

                if (!isEmpty) {
                    const dayClass = isToday ? 'bg-blue-600 text-white rounded-full px-2 py-1 text-sm font-bold' : 'text-gray-700 font-medium';
                    html += `<div class="text-right"><span class="${dayClass}">${day}</span></div>`;

                    // Add events for this day
                    if (data.events[day]) {
                        html += '<div class="mt-1 space-y-1">';
                        data.events[day].forEach(event => {
                            html += `
                                <div class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded cursor-pointer hover:bg-blue-200 transition"
                                     onclick="showEventModal(${event.id}, '${escapeHtml(event.title)}', '${escapeHtml(event.description)}', '${event.full_datetime}', '${escapeHtml(event.location)}', '${escapeHtml(event.created_by)}')">
                                    <div class="font-semibold truncate">${event.time}</div>
                                    <div class="truncate">${escapeHtml(event.title)}</div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                }

                html += '</div>';
            });
        });

        grid.innerHTML = html;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showEventModal(id, title, description, datetime, location, createdBy) {
        const modalHtml = `
            <div id="eventModal${id}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) closeEventModal(${id})">
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-2xl font-bold text-gray-900">${title}</h3>
                        <button onclick="closeEventModal(${id})" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <p class="text-gray-700">${description}</p>
                        <div class="flex items-center text-gray-600">
                            <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-medium">${datetime}</span>
                        </div>
                        ${location ? `
                        <div class="flex items-center text-gray-600">
                            <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>${location}</span>
                        </div>
                        ` : ''}
                        <div class="flex items-center text-sm text-gray-500">
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span>Posted by ${createdBy}</span>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button onclick="closeEventModal(${id})" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('dynamicModals').innerHTML = modalHtml;
    }

    function closeEventModal(id) {
        document.getElementById('dynamicModals').innerHTML = '';
    }

    function toggleMonthDropdown() {
        const dropdown = document.getElementById('monthDropdown');
        dropdown.classList.toggle('hidden');
    }

    function populateMonthDropdown() {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

        const now = new Date();
        const minDate = new Date(now);
        minDate.setFullYear(minDate.getFullYear() - 1);

        const maxDate = new Date(now);
        maxDate.setFullYear(maxDate.getFullYear() + 1);

        const content = document.getElementById('monthDropdownContent');
        let html = '';

        // Generate list of available months
        const currentDate = new Date(minDate);
        let lastYear = null;

        while (currentDate <= maxDate) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;

            // Add year header when year changes
            if (year !== lastYear) {
                if (lastYear !== null) {
                    html += '<div class="border-t border-gray-200 my-2"></div>';
                }
                html += `<div class="text-xs font-semibold text-gray-500 px-3 py-2">${year}</div>`;
                lastYear = year;
            }

            const isCurrentMonth = year === currentYear && month === currentMonth;
            const bgClass = isCurrentMonth ? 'bg-blue-100 text-blue-900 font-semibold' : 'text-gray-700 hover:bg-gray-100';

            html += `
                <button onclick="navigateToMonth(${year}, ${month})" class="w-full text-left px-4 py-2 rounded transition ${bgClass}">
                    ${monthNames[month - 1]} ${year}
                </button>
            `;

            currentDate.setMonth(currentDate.getMonth() + 1);
        }

        content.innerHTML = html;
    }

    function navigateToMonth(year, month) {
        currentYear = year;
        currentMonth = month;
        loadCalendar(year, month);
        document.getElementById('monthDropdown').classList.add('hidden');
        preloadAdjacentMonths();
    }
</script>

{% endblock %}
