<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vote</title>
</head>
{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Vote{% endblock %}

{% block content %}
    <div class="container mx-auto p-6 mt-6 bg-white shadow-lg rounded-lg">
        <h1 class="text-3xl font-bold text-center mb-4">Legislation up for Vote</h1>

    {% if profile.member_type in 'Chair Officer' %}
        <form method="POST" enctype="multipart/form-data" class="space-y-4 mb-10 bg-white p-6 rounded shadow">
            {% csrf_token %}
            <input type="hidden" name="upload_submit" value="1">

            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold">Upload Legislation</h2>
                <div class="flex items-center gap-2">
                    <label for="vote_mode">Voting Mode:</label>
                    <select id="vote_mode" name="vote_mode" class="border px-2 py-1 rounded">
                        <option value="percentage" selected>Percentage</option>
                        <option value="piecewise">Piecewise</option>
                        <option value="plurality">Plurality</option>
                    </select>
                </div>
            </div>

            <label class="block">Title:</label>
            <input type="text" name="title" required class="w-full border rounded px-3 py-2">

            <label class="block">Description:</label>
            <textarea name="description" required class="w-full border rounded px-3 py-2"></textarea>

            <label class="block">Available At:</label>
            <input type="datetime-local" name="available_at" required class="w-full border rounded px-3 py-2">

            <label class="block">Upload Document:</label>
            <input type="file" id="documentUpload" name="document" accept=".pdf,.docx" required>

            <div class="flex gap-3">
                <input type="checkbox" name="anonymous" id="anonymous">
                <label for="anonymous">Make Vote Anonymous</label>
            </div>
            <div class="flex gap-3" id="removeAbstainWrapper">
                <input type="checkbox" name="remove_abstain" id="remove_abstain">
                <label for="remove_abstain">Remove Abstain Option</label>
            </div>

            <!-- Percentage Mode -->
            <div id="percentage-section">
                <label>Required Vote to Pass:</label>
                <select name="required_percentage" class="w-full border rounded px-3 py-2">
                    <option value="51">51%</option>
                    <option value="60">60%</option>
                    <option value="67">67%</option>
                    <option value="75">75%</option>
                    <option value="100">Unanimous</option>
                </select>
            </div>

            <!-- Piecewise Mode -->
            <div id="piecewise-section" class="hidden">
                <label>Piecewise Rules:</label>
                <textarea name="piecewise_rules" placeholder="e.g., Seniors: 80%, Juniors: 60%" class="w-full border rounded px-3 py-2"></textarea>
            </div>

            <!-- Plurality Mode -->
            <div id="plurality-options" class="mt-4 hidden">
                <label class="block font-medium mb-1">Plurality Options (at least 2):</label>
                <div class="space-y-2">
                    <input type="text" name="plurality_option_1" placeholder="Option 1" class="w-full border rounded px-3 py-2">
                    <input type="text" name="plurality_option_2" placeholder="Option 2" class="w-full border rounded px-3 py-2">
                    <input type="text" name="plurality_option_3" placeholder="Option 3 (optional)" class="w-full border rounded px-3 py-2">
                    <input type="text" name="plurality_option_4" placeholder="Option 4 (optional)" class="w-full border rounded px-3 py-2">
                    <input type="text" name="plurality_option_5" placeholder="Option 5 (optional)" class="w-full border rounded px-3 py-2">
                </div>
            </div>

            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Upload</button>
        </form>
    {% endif %}

    <script>
        const modeSelect = document.getElementById("vote_mode");
        const percentDiv = document.getElementById("percentage-section");
        const piecewiseDiv = document.getElementById("piecewise-section");
        const pluralityDiv = document.getElementById("plurality-section");

        modeSelect.addEventListener("change", () => {
            const mode = modeSelect.value;
            percentDiv.classList.toggle("hidden", mode !== "percentage");
            piecewiseDiv.classList.toggle("hidden", mode !== "piecewise");
            pluralityDiv.classList.toggle("hidden", mode !== "plurality");
        });

        function togglePluralityFields(value) {
            const pluralityDiv = document.getElementById('plurality-options');
            const fileInput = document.getElementById('documentUpload');
            const abstainDiv = document.getElementById('removeAbstainWrapper');

            if (value === 'plurality') {
                pluralityDiv.classList.remove('hidden');
                fileInput.removeAttribute('required');
                abstainDiv.classList.add('hidden');
            } else {
                pluralityDiv.classList.add('hidden');
                fileInput.setAttribute('required', 'required');
                abstainDiv.classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const voteModeSelect = document.querySelector('select[name="vote_mode"]');
            if (voteModeSelect) {
                togglePluralityFields(voteModeSelect.value);
                voteModeSelect.addEventListener('change', function(e) {
                    togglePluralityFields(e.target.value);
                });
            }
        });
    </script>


    {% if messages %}
        {% for message in messages %}
        <div class="p-3 rounded bg-green-100 text-green-800 mb-3">{{ message }}</div>
        {% endfor %}
    {% endif %}

    {% if not legislation %}
    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
        <p class="text-lg text-center">Currently, there is no legislation up for vote.</p>
        <p class="text-center mt-4">
            <a href="{% url 'passed_legislation' %}" class="text-blue-500 hover:text-blue-800">View Legislation Already Passed</a>
        </p>
    </div>
    {% else %}
        {% for leg in legislation %}
        <div class="bg-white p-5 mb-6 rounded shadow">
            <h3 class="text-xl font-bold">{{ leg.title }}</h3>
            <p>{{ leg.description }}</p>
            <p class="text-sm text-gray-500 mb-2">Available At: {{ leg.available_at|date:"F j, Y, g:i a" }}</p>
            {% if leg.document %}
                <a href="{{ leg.document.url }}" class="text-blue-600 underline" target="_blank">View Document</a>
            {% endif %}


            {% if profile == leg.posted_by %}
                {% with data=vote_data|get_item:leg.id %}
                {% if data %}
                <div class="mt-4 bg-gray-100 p-4 rounded">
                    <h4 class="font-semibold mb-2">Live Vote Tally</h4>
                    <ul class="text-sm">
                        {% if leg.vote_mode == "plurality" %}
                            {% for option, count in data.items %}
                                {% if option != "total" %}
                                    <li>{{ option }}: {{ count }}</li>
                                {% endif %}
                            {% endfor %}
                            <li>üßÆ Total Votes: {{ data.total }}</li>
                        {% else %}
                            <li>‚úÖ Yes: {{ data.yes }}</li>
                            <li>‚ùå No: {{ data.no }}</li>
                            <li>‚ö™ Abstain: {{ data.abstain }}</li>
                            <li>üßÆ Total Votes: {{ data.total }}</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                {% endwith %}
            {% endif %}

            {% if profile == leg.posted_by and not leg.voting_closed %}
            <form method="post" action="{% url 'end_vote' leg.id %}" class="mt-3">
                {% csrf_token %}
                <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">End Vote</button>
            </form>
            {% endif %}

            {% if not can_vote %}
                <div class="bg-yellow-100 text-yellow-800 p-4 rounded mb-6">
                    You are marked as absent and cannot vote on this legislation.
                </div>
            {% endif %}

            {% if can_vote %}
            <form method="post" class="mt-4">
                {% csrf_token %}
                <input type="hidden" name="legislation_id" value="{{ leg.id }}">
                <label class="block font-medium mb-1">Vote:</label>
                <div class="space-x-4">
                    {% if leg.vote_mode == "plurality" %}
                        {% for option in leg.plurality_options %}
                            <label><input type="radio" name="vote_choice" value="{{ option }}"> {{ option }}</label>
                        {% endfor %}
                    {% else %}
                        <label><input type="radio" name="vote_choice" value="yes"> Yes</label>
                        <label><input type="radio" name="vote_choice" value="no"> No</label>
                        {% if leg.allow_abstain %}
                            <label><input type="radio" name="vote_choice" value="abstain"> Abstain</label>
                        {% endif %}
                    {% endif %}
                </div>
                <input type="password" name="password" placeholder="Confirm Password"
                       class="w-full border rounded px-3 py-2 mt-2">
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded mt-2">Submit Vote</button>
            </form>
            {% endif %}
        </div>
        {% endfor %}
    {% endif %}
</div>
{% endblock %}
</html>
