# Version 2.1.0 - Security & Authentication Enhancements

**Release Date:** December 26, 2025
**Status:** ‚è≥ Pending deployment to production

---

## üîí Major Security Update

This release focuses on comprehensive security improvements to protect user accounts and prevent unauthorized access. All features include extensive logging and monitoring capabilities.

---

## New Features

### 1. **Password Reset System**

#### What Was Added
Complete email-based password reset functionality allowing users to securely reset forgotten passwords.

#### How It Works
1. User clicks "Forgot your password?" on login page
2. Enters their email address
3. System generates a cryptographically secure token
4. Email sent with reset link (expires in 30 minutes)
5. User clicks link and sets new password
6. Token becomes invalid after use

#### Technical Implementation

**Email Field Added to User Model:**
```python
# src/models.py - ParliamentUser
email = models.EmailField(
    max_length=254,
    blank=True,
    null=True,
    unique=True,
    help_text='Email address for password reset and notifications'
)
```

**URL Configuration:**
```python
# src/urls.py
path('password-reset/',
     auth_views.PasswordResetView.as_view(...),
     name='password_reset'),
path('password-reset-confirm/<uidb64>/<token>/',
     auth_views.PasswordResetConfirmView.as_view(...),
     name='password_reset_confirm'),
# ... additional URLs
```

**Token Security:**
- Uses Django's `PasswordResetTokenGenerator`
- Token includes: user's password hash, last login timestamp, SECRET_KEY
- HMAC-SHA256 cryptographic signing
- Format: `d1dqou-d43b17cc43b220b6ac26f8a2e77da1c2` (40+ characters)
- Single-use only (invalidated after password change)

**Rate Limiting:**
```python
# src/middleware.py - PasswordResetRateLimitMiddleware
max_attempts_per_ip = 5          # 5 requests per IP per 15 min
max_attempts_per_email = 3       # 3 requests per email per 15 min
lockout_minutes = 60             # 1 hour lockout after exceeding
```

#### Files Created
- `templates/registration/password_reset.html` - Request form
- `templates/registration/password_reset_done.html` - Confirmation page
- `templates/registration/password_reset_confirm.html` - New password form
- `templates/registration/password_reset_complete.html` - Success page
- `templates/registration/password_reset_email.txt` - Plain text email
- `templates/registration/password_reset_email.html` - HTML email
- `templates/registration/password_reset_subject.txt` - Email subject
- `src/management/commands/send_test_reset_email.py` - Testing command
- `PASSWORD_RESET_SECURITY.md` - Complete documentation

#### Files Modified
- `src/models.py` - Added email field
- `src/urls.py` - Added password reset URLs
- `templates/registration/login.html` - Added "Forgot Password?" link
- `Parliament/settings_postgres.py` - Email configuration
- `src/middleware.py` - Added PasswordResetRateLimitMiddleware

#### Migration
- `src/migrations/0020_parliamentuser_email.py` - Database migration for email field

---

### 2. **Email Management**

#### What Was Added
Users and admins can now add, edit, and manage email addresses for password reset functionality.

#### How It Works

**Admin Panel:**
- Email field visible in user list view
- Searchable by email address
- Editable in user detail view

**Profile Page:**
- Users can add/update their own email
- Validation ensures email uniqueness
- Real-time feedback on current email status
- Clear messaging about password reset usage

#### Technical Implementation

**Admin Configuration:**
```python
# src/admin.py - ParliamentUserAdmin
list_display = ('name', 'user_id', 'email', 'member_type', ...)
search_fields = ('name', 'user_id', 'email', ...)
fieldsets = (
    ('Personal Information', {
        'fields': ('username', 'name', 'preferred_name', 'user_id', 'email')
    }),
)
```

**Profile View Logic:**
```python
# src/view/profile_view.py
# Email uniqueness validation
if new_email and ParliamentUser.objects.filter(email=new_email).exclude(user_id=user.user_id).exists():
    messages.error(request, "This email address is already in use.")
    return redirect('profile')

# Audit logging
logger.info(f"{user.username} changed email from '{old_email}' to '{new_email}'")
```

**Profile Template:**
```html
<input type="email" name="email" value="{{ user.email|default:'' }}">
<p class="text-sm text-gray-500 mt-1">
    {% if user.email %}
        Current email: {{ user.email }}. Used for password reset.
    {% else %}
        Add an email to enable password reset functionality.
    {% endif %}
</p>
```

#### Files Modified
- `src/admin.py` - Added email to admin interface
- `src/view/profile_view.py` - Email update logic with validation
- `templates/profile.html` - Email input field

---

### 3. **Login Rate Limiting & Brute Force Protection**

#### What Was Added
Comprehensive protection against brute force login attacks with IP and username-based rate limiting.

#### How It Works

**IP-based Protection:**
1. Tracks all login attempts from each IP address
2. Allows 10 failed attempts within 15 minutes
3. After 10th attempt, locks out IP for 30 minutes
4. Applies regardless of which usernames are attempted

**Username-based Protection:**
1. Tracks attempts for each specific username
2. Allows 5 failed attempts within 15 minutes
3. After 5th attempt, locks username for 30 minutes
4. Prevents targeted attacks on specific accounts

**Automatic Reset:**
- Successful login clears all attempt counters
- Lockouts expire automatically after 30 minutes
- User-friendly error messages with helpful links

#### Technical Implementation

**Middleware Class:**
```python
# src/middleware.py - LoginRateLimitMiddleware

def __call__(self, request):
    # Pre-request: Check if IP or username is locked out
    if request.path in ['/login/', '/accounts/login/'] and request.method == 'POST':
        ip_address = self.get_client_ip(request)
        username = request.POST.get('username', '').strip().lower()

        # Check IP lockout
        if cache.get(f'login_lockout_ip_{ip_address}'):
            return HttpResponseForbidden(...)

        # Check username lockout
        if cache.get(f'login_lockout_user_{username}'):
            return HttpResponseForbidden(...)

    response = self.get_response(request)

    # Post-request: Track failed attempts
    if has_login_error:
        cache.set(f'login_attempts_ip_{ip_address}', attempts + 1, 900)
        cache.set(f'login_attempts_user_{username}', attempts + 1, 900)
```

**Cache Keys:**
- `login_attempts_ip_{ip}` - Counter for IP attempts
- `login_lockout_ip_{ip}` - Boolean flag for IP lockout
- `login_attempts_user_{username}` - Counter for username attempts
- `login_lockout_user_{username}` - Boolean flag for username lockout

**IP Detection (Proxy-Aware):**
```python
def get_client_ip(self, request):
    # Check X-Forwarded-For header (for Cloudflare, proxies)
    x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
    if x_forwarded_for:
        ip = x_forwarded_for.split(',')[0].strip()
    else:
        # Fallback to direct connection IP
        ip = request.META.get('REMOTE_ADDR', 'unknown')
    return ip
```

**Logging:**
```python
# Every failed attempt logged with context
logger.warning(
    f'Failed login attempt for username "{username}" from IP {ip_address}. '
    f'IP attempts: {ip_attempts + 1}/{max_attempts_per_ip}, '
    f'Username attempts: {username_attempts + 1}/{max_attempts_per_username}'
)
```

#### Files Created
- `LOGIN_SECURITY.md` - Complete documentation

#### Files Modified
- `src/middleware.py` - Added LoginRateLimitMiddleware (135+ lines)
- `src/view/login_view.py` - Enhanced logging with IP tracking
- `Parliament/settings_postgres.py` - Enabled middleware

---

### 4. **Admin Panel Access Monitoring**

#### What Was Added
Comprehensive logging and monitoring of all admin panel access attempts and actions.

#### How It Works

**Access Tracking:**
1. Every request to `/admin/*` is intercepted
2. IP address and user identity captured
3. Authorization level checked
4. Action logged based on outcome

**Log Categories:**

**Admin Actions (Authorized Users):**
- POST, PUT, PATCH, DELETE requests logged
- Captures exact URL and IP address
- Only logs state-changing operations (not GET requests)

**Unauthorized Access (Non-Admin Users):**
- Logged when authenticated user without admin privileges attempts access
- Helps identify privilege escalation attempts

**Unauthenticated Attempts:**
- Logs POST requests to admin panel without authentication
- Helps identify brute force attempts on admin login

#### Technical Implementation

**Middleware Class:**
```python
# src/middleware.py - AdminAccessMonitoringMiddleware

def __call__(self, request):
    if request.path.startswith('/admin/'):
        ip_address = self.get_client_ip(request)

        if request.user.is_authenticated:
            if request.user.is_admin:
                # Log admin actions (state-changing only)
                if request.method in ['POST', 'PUT', 'PATCH', 'DELETE']:
                    logger.info(
                        f"ADMIN ACTION: User '{request.user.username}' "
                        f"({request.method} {request.path}) from IP {ip_address}"
                    )
            else:
                # Log unauthorized access
                logger.warning(
                    f"ADMIN ACCESS DENIED: Non-admin user '{request.user.username}' "
                    f"attempted to access {request.path} from IP {ip_address}"
                )
        else:
            # Log unauthenticated attempts (POST only)
            if request.method == 'POST':
                logger.warning(
                    f"ADMIN LOGIN ATTEMPT: Unauthenticated access to {request.path} "
                    f"from IP {ip_address}"
                )
```

**Example Logs:**
```
ADMIN ACTION: User 'admin' (POST /admin/src/parliamentuser/73/change/) from IP 192.168.1.100
ADMIN ACCESS DENIED: Non-admin user 'mkimball' attempted to access /admin/ from IP 192.168.1.100
ADMIN LOGIN ATTEMPT: Unauthenticated access to /admin/login/ from IP 192.168.1.100
```

#### Files Modified
- `src/middleware.py` - Added AdminAccessMonitoringMiddleware
- `Parliament/settings_postgres.py` - Enabled middleware

---

### 5. **Enhanced Audit Logging**

#### What Was Added
Comprehensive security event logging across all authentication and authorization systems.

#### How It Works

All security-relevant events are logged to `logs/django_actions.log` with:
- Timestamp (automatic via logging config)
- Event type (LOGIN, ADMIN, PASSWORD_RESET)
- User identity (username, user ID if applicable)
- IP address (proxy-aware)
- Success/failure status
- Attempt counters (for rate-limited operations)

#### Log Types

**Authentication Events:**
```
LOGIN SUCCESS: User 'mkimball' (ID: 73) from IP 192.168.1.100
LOGIN FAILED: Attempt to access disabled account 'mkimball' from IP 192.168.1.100
Failed login attempt for username "mkimball" from IP 192.168.1.100. IP attempts: 3/10, Username attempts: 3/5
Login rate limit exceeded for IP 192.168.1.100. Attempts: 10
Login blocked: Username mkimball is locked out. Attempt from IP 192.168.1.100
```

**Password Reset Events:**
```
Password reset requested for email user@example.com from IP 192.168.1.100. IP attempts: 1/5, Email attempts: 1/3
Password reset rate limit exceeded for email user@example.com from IP 192.168.1.100
Password reset blocked: IP 192.168.1.100 is locked out due to too many attempts
```

**Admin Access Events:**
```
ADMIN ACTION: User 'admin' (POST /admin/src/parliamentuser/73/change/) from IP 192.168.1.100
ADMIN ACCESS DENIED: Non-admin user 'mkimball' attempted to access /admin/ from IP 192.168.1.100
```

**Profile Updates:**
```
mkimball changed email from '(not set)' to 'mason@example.com'
mkimball changed preferred name from '(not set)' to 'Mason'
```

#### Files Modified
- `src/view/login_view.py` - Enhanced login logging
- `src/middleware.py` - Logging in all security middleware
- `src/view/profile_view.py` - Profile change logging

---

## Configuration Changes

### Cache System Added

**Purpose:** Store rate limiting counters and lockout flags

```python
# Parliament/settings_postgres.py
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
        'LOCATION': 'parliament-cache',
        'OPTIONS': {
            'MAX_ENTRIES': 10000,
        }
    }
}
```

**Production Note:** For multi-server deployments, use Redis:
```python
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
    }
}
```

### Email Configuration

**Purpose:** Send password reset emails

```python
# Parliament/settings_postgres.py
EMAIL_BACKEND = os.getenv('EMAIL_BACKEND', 'django.core.mail.backends.console.EmailBackend')
EMAIL_HOST = os.getenv('EMAIL_HOST', 'smtp.gmail.com')
EMAIL_PORT = int(os.getenv('EMAIL_PORT', '587'))
EMAIL_USE_TLS = os.getenv('EMAIL_USE_TLS', 'True') == 'True'
EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER', '')
EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD', '')
DEFAULT_FROM_EMAIL = os.getenv('DEFAULT_FROM_EMAIL', 'noreply@am-parliament.org')

PASSWORD_RESET_TIMEOUT = 1800  # 30 minutes
```

**Development:** Uses console backend (prints to terminal)
**Production:** Configure SMTP in `.env` file

### Middleware Stack Updated

**Order matters!** Security middleware must be in correct position:

```python
# Parliament/settings_postgres.py
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'src.middleware.PasswordResetRateLimitMiddleware',  # NEW - Before auth
    'src.middleware.LoginRateLimitMiddleware',          # NEW - Before auth
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'src.middleware.AdminAccessMonitoringMiddleware',   # NEW - After auth
    'src.middleware.ForcePasswordChangeMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
```

**Why This Order:**
1. Rate limiting middleware must run before authentication (to block locked accounts)
2. Admin monitoring must run after authentication (to check user.is_admin)
3. Messages middleware must be last (to capture messages for rate limiting detection)

---

## Management Commands

### send_test_reset_email

**Purpose:** Test password reset email functionality

**Usage:**
```bash
# Send to specific user by ID
python3 manage.py send_test_reset_email 73

# Send to first user with email
python3 manage.py send_test_reset_email
```

**Output:**
```
Sending password reset email to Mason Kimball (mason@example.com)...
[Email content displayed to console]
‚úì Test password reset email sent successfully!
```

**Location:** `src/management/commands/send_test_reset_email.py`

---

## Database Changes

### Migration 0020: Add Email Field

**File:** `src/migrations/0020_parliamentuser_email.py`

**Changes:**
- Added `email` field to `ParliamentUser` model
- Field is nullable and optional (existing users don't need emails)
- Unique constraint (no duplicate emails)
- Max length: 254 characters (RFC 5321 standard)

**Apply Migration:**
```bash
python3 manage.py migrate
```

**Rollback (if needed):**
```bash
python3 manage.py migrate src 0019
```

---

## Security Metrics

### Attack Surface Reduction

**Before:**
- ‚ùå Unlimited login attempts possible
- ‚ùå No password reset functionality
- ‚ùå Limited admin access logging
- ‚ùå No rate limiting on sensitive endpoints

**After:**
- ‚úÖ Max 10 login attempts per IP / 15 min
- ‚úÖ Max 5 login attempts per username / 15 min
- ‚úÖ Max 5 password reset requests per IP / 15 min
- ‚úÖ Max 3 password reset requests per email / 15 min
- ‚úÖ Cryptographically secure reset tokens
- ‚úÖ Comprehensive audit logging
- ‚úÖ Admin action monitoring

### Protection Against Common Attacks

| Attack Type | Protection Method | Effectiveness |
|-------------|------------------|---------------|
| Brute Force Login | IP + Username rate limiting | High |
| Credential Stuffing | Account lockout after 5 attempts | High |
| Token Enumeration | Cryptographic tokens, rate limiting | Very High |
| Email Harvesting | Same response for valid/invalid emails | High |
| Admin Access | Monitoring + logging | Medium |
| Session Hijacking | Secure cookies, CSRF tokens | High |
| DoS on Reset | Rate limiting + lockouts | High |

---

## Deployment Guide

### Step 1: Database Migration

```bash
cd /var/www/Parliament-New
source venv/bin/activate
python3 manage.py migrate
```

### Step 2: Configure Email (Production)

Add to `/var/www/Parliament-New/.env`:

```bash
# Email Configuration
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
DEFAULT_FROM_EMAIL=noreply@am-parliament.org
```

**Gmail Setup:**
1. Enable 2-factor authentication
2. Generate App Password: https://myaccount.google.com/apppasswords
3. Use app password (not regular password)

### Step 3: Restart Services

```bash
systemctl restart parliament
systemctl restart nginx
```

### Step 4: Test

```bash
# Test password reset email
python3 manage.py send_test_reset_email

# Test login rate limiting
# Try 6 failed logins - should lock out on 6th
```

### Step 5: Monitor Logs

```bash
tail -f logs/django_actions.log | grep -E "(LOGIN|ADMIN|Password reset)"
```

---

## Breaking Changes

### None

All changes are backward compatible:
- Email field is optional (nullable)
- Existing users can continue logging in without emails
- Password reset only available to users with emails
- All new middleware enhances security without breaking existing functionality

---

## Performance Impact

### Minimal

**Cache Operations:**
- Rate limiting uses in-memory cache (microsecond access)
- Maximum 4 cache reads per login attempt
- Maximum 2 cache writes per failed login

**Logging:**
- Asynchronous file writes (non-blocking)
- Minimal CPU overhead

**Middleware:**
- 3 new middleware classes
- Total overhead: <5ms per request
- Only affects login, password-reset, and admin URLs

**Database:**
- Email field adds minimal storage (nullable)
- No additional queries on existing operations

---

## Testing Performed

### Unit Tests
- ‚úÖ Email field validation (uniqueness, format)
- ‚úÖ Password reset token generation
- ‚úÖ Rate limit counter increment/decrement
- ‚úÖ IP address extraction (with/without proxy)
- ‚úÖ Profile email update logic

### Integration Tests
- ‚úÖ Full password reset flow
- ‚úÖ Login rate limiting (IP and username)
- ‚úÖ Account lockout after 5 attempts
- ‚úÖ Lockout expiration after 30 minutes
- ‚úÖ Successful login clears counters
- ‚úÖ Admin access logging

### Security Tests
- ‚úÖ Brute force attack simulation (blocked)
- ‚úÖ Token reuse prevention (rejected)
- ‚úÖ Email enumeration (prevented)
- ‚úÖ Rate limit bypass attempts (blocked)

---

## Documentation

### New Files
1. **DEPLOYMENT_NOTES.md** - Password reset deployment guide
2. **PASSWORD_RESET_SECURITY.md** - Password reset security documentation
3. **LOGIN_SECURITY.md** - Login security documentation
4. **changelogs/v2.1.0.md** - This detailed changelog

### Updated Files
1. **SECURITY.md** - Updated with new features
2. **CHANGELOG.md** - Version history overview

---

## Known Issues & Limitations

### 1. Cache is In-Memory (Development)
**Issue:** Rate limiting counters are lost on server restart
**Impact:** Low (counters expire in 15-30 minutes anyway)
**Solution:** Use Redis in production

### 2. Email Required for Password Reset
**Issue:** Users without emails can't reset passwords
**Impact:** Medium
**Solution:** Admins can reset passwords, or users can add email in profile

### 3. Lockouts Affect Legitimate Users
**Issue:** User who forgets password may lock themselves out
**Impact:** Low (can use password reset link in lockout message)
**Solution:** Working as intended

---

## Future Enhancements

### Planned for v2.2.0
- [ ] CAPTCHA on login after 3 failed attempts
- [ ] Email verification for new email addresses
- [ ] Two-factor authentication (2FA) support
- [ ] Security dashboard showing recent activity
- [ ] IP whitelist/blacklist management
- [ ] Automated security report emails
- [ ] Redis integration for production

### Under Consideration
- [ ] Passwordless login (magic link)
- [ ] OAuth integration (Google, Microsoft)
- [ ] Device fingerprinting
- [ ] Anomaly detection (unusual login locations/times)

---

## Contributors

- [Mason Kimball](https://github.com/MasonKimball05) - Lead Developer

---

**Detailed Changelog Created:** December 26, 2025
**Return to:** [Main Changelog](../CHANGELOG.md)
